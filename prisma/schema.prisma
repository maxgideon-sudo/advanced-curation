// Advanced Curation Deal Desk Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?  // Only set when they convert from Lead to Client
  name      String?
  company   String?  // Brand or Agency name
  role      Role     @default(LEAD)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  deals Deal[]

  @@map("users")
}

// Dedicated Lead table for tracking potential clients
model Lead {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  company       String?  // Brand or Agency name
  phone         String?
  source        String?  // How they found us (website, referral, etc.)
  status        LeadStatus @default(NEW)
  notes         String?  @db.Text
  lastContact   DateTime?
  convertedAt   DateTime? // When they became a client
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  deals         Deal[]   // Deals created before conversion
  convertedToClient Client? @relation("LeadToClient")

  @@map("leads")
}

// Dedicated Client table for converted leads and direct signups
model Client {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String   // Required for clients
  name        String?
  company     String?  // Brand or Agency name
  phone       String?
  billingAddress Json? // Flexible billing address storage
  subscriptionPlan String? // Future: subscription tiers
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  deals       Deal[]
  leadId      String?  @unique // Reference to original lead if converted
  originalLead Lead?   @relation("LeadToClient", fields: [leadId], references: [id])

  @@map("clients")
}

model Deal {
  id          String   @id @default(cuid())
  dealId      String   @unique // Generated Deal ID for DSP
  email       String?  // For leads who haven't created account yet
  company     String?  // Brand or Agency name
  dsp         String   // DSP platform (DV360, TTD, Amazon DSP, etc.)
  seatId      String?  // DSP Seat ID
  mediaType   MediaType
  flightStart DateTime?
  flightEnd   DateTime?
  alwaysOn    Boolean  @default(false)
  geoTargeting Json?   // Flexible geo targeting data
  idealInventory String @db.Text // Open text field for OpenAI analysis
  aiAnalysis  String?  @db.Text // Result from OpenAI analysis
  status      DealStatus @default(ACTIVE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations - can be associated with User (legacy), Lead, or Client
  userId String?
  user   User?  @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  leadId String?
  lead   Lead?  @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Media-specific data
  ctvApps     CtvApp[]
  domains     Domain[]
  inAppList   InAppItem[]
  
  @@map("deals")
}

model DSP {
  id   String @id @default(cuid())
  name String @unique
  code String @unique // Short code for the DSP
  
  @@map("dsps")
}

model SeatId {
  id    String @id @default(cuid())
  seatId String @unique
  dspId String
  name  String? // Optional name/description
  
  @@map("seat_ids")
}

model CtvApp {
  id       String @id @default(cuid())
  name     String
  bundleId String @unique
  dealId   String
  deal     Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  @@map("ctv_apps")
}

model Domain {
  id     String @id @default(cuid())
  domain String
  dealId String
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  @@map("domains")
}

model InAppItem {
  id       String @id @default(cuid())
  appName  String
  bundleId String
  dealId   String
  deal     Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  @@map("in_app_items")
}

// Geo targeting reference data
model State {
  id   String @id @default(cuid())
  name String @unique
  code String @unique // State abbreviation
  
  @@map("states")
}

model DMA {
  id   String @id @default(cuid())
  name String @unique
  code String @unique
  
  @@map("dmas")
}

model City {
  id      String @id @default(cuid())
  name    String
  state   String
  stateCode String
  
  @@map("cities")
}

model ZipCode {
  id   String @id @default(cuid())
  zip  String @unique
  city String
  state String
  
  @@map("zip_codes")
}

enum Role {
  LEAD
  CLIENT
  ADMIN
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL_SENT
  NEGOTIATING
  CONVERTED
  LOST
}

enum MediaType {
  CTV
  OLV
  DISPLAY
  IN_APP
}

enum DealStatus {
  ACTIVE
  PAUSED
  EXPIRED
  DRAFT
}
